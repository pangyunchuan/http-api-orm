var S=Object.defineProperty,b=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var M=(s,i,r)=>i in s?S(s,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[i]=r,u=(s,i)=>{for(var r in i||(i={}))P.call(i,r)&&M(s,r,i[r]);if(I)for(var r of I(i))O.call(i,r)&&M(s,r,i[r]);return s},h=(s,i)=>b(s,E(i));var o=(s,i,r)=>(M(s,typeof i!="symbol"?i+"":i,r),r);(function(s,i){typeof exports=="object"&&typeof module!="undefined"?i(exports,require("axios"),require("lodash-es")):typeof define=="function"&&define.amd?define(["exports","axios","lodash-es"],i):(s=typeof globalThis!="undefined"?globalThis:s||self,i(s.MyLib={},s.axios,s["lodash-es"]))})(this,function(s,i,r){"use strict";function y(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var w=y(i);class F{constructor(){o(this,"_dataType",{});o(this,"isProxyData",!1)}proxyData(){return this.isProxyData?this:(this.isProxyData=!0,new Proxy(this,{get(t,e){if(e in t)return t[e];if(t.data)return t.data[e]},set(t,e,n){return e in t?(t[e]=n,!0):(t.data&&e in t.data&&(t.data[e]=n),!0)},has(t,e){return e in t||t.data&&e in t.data}}))}}let p={};function B(){return p}function N(l){p=l}let C={};function R(){return C}function x(l){C=l}let f={use:!0};function D(l){f=u(u({},f),l)}class _ extends F{constructor(){super(...arguments);o(this,"useLoading",f.use)}static newReq(t="default"){return new this().newReq(t)}newReq(t="default"){const e=B(),n=new e[t];if(!n)throw new Error(`${t} \u8BF7\u6C42\u7C7B \u4E0D\u5B58\u5728`);return n.setModel(this).setUseLoading(this.useLoading)}newFromReq(t,e,n){if(!e)throw new Error(`\u6A21\u578B\u6570\u636E\u6709\u8BEF:${e}`);const a=new t().proxyData();return a.data=e,n&&n(a),a}}const q=class{constructor(){o(this,"config",{});o(this,"response");o(this,"error")}setCancel(){let{config:t}=this;if(t.cancelMark==="")return;let e;t.cancelMark=e=t.cancelMark||"default";let{cancelMapByMark:n}=q,a=n[e]=n[e]||w.default.CancelToken.source();t.cancelToken=a.token}static cancelByMark(t){let{cancelMapByMark:e}=q;!e[t]||(e[t].cancel(),delete e[t])}async request(t={}){return this.config=u(u({},this.config),t),this.requestHandle(),this.setCancel(),w.default.request(this.config).then(e=>(this.response=e,this.responseHandle())).catch(e=>{throw this.error=e,this.errorHandle()})}setGet(t,e={},n={}){return this.config=u(h(u({},this.config),{url:t,params:e}),n),this}setPost(t,e={},n={},a={}){return this.config=u(h(u({},this.config),{url:t,data:e,params:n}),a),this}get(t,e={},n={}){return this.request(u({method:"get",url:t,params:e},n))}post(t,e={},n={},a={}){return this.request(u({method:"post",url:t,data:e},a))}};let L=q;o(L,"cancelMapByMark",{});class T extends L{constructor(){super(...arguments);o(this,"useLoading",f.use);o(this,"loading");o(this,"model")}setUseLoading(t=f.use){return this.useLoading=t,this}setLoading(t={},e="default"){const n=R();return this.loading=new n[e](t),this}getLoading(){return!this.loading&&this.useLoading&&this.setLoading(),this.loading}setModel(t){return this.model=t,this}getModel(){if(!this.model)throw new Error("\u8BF7\u5148\u8BBE\u7F6E\u6A21\u578B");return this.model}async request(t={}){let e=this.getLoading();return e==null||e.startLoading(),super.request(t).then(n=>(e==null||e.endLoading(),n)).catch(n=>{throw e==null||e.endLoading(),n})}reqOne(t,e){return this.request().then(n=>this.getModel().newFromReq(t,n,e))}reqOneOther(t,e,n){return this.request().then(a=>{const c=a[e],m=this.getModel().newFromReq(t,c,n);return h(u({},r.omit(a,e)),{model:m})})}reqMany(t,e){return this.request().then(n=>{let a=[];for(const c of n)a.push(this.getModel().newFromReq(t,c,e));return a})}reqManyOther(t,e,n){return this.request().then(a=>{const c=a[e],m=[];for(const k of c)m.push(this.getModel().newFromReq(t,k,n));return h(u({},r.omit(a,e)),{models:m})})}}const d=class{constructor(t={}){o(this,"needWaitLoading",!0);o(this,"reqIngNum",0);o(this,"reqCount",0);o(this,"fullLoadingSingleInst");o(this,"loadingInst");o(this,"_options",{});o(this,"options",{});o(this,"_waitLoading");o(this,"_waitClose");const e=d.defaultConfigByClassName[this.classname]||{};return this.options=u(u(u({},this.options),e),t),this}get isFull(){return this.getIsFull()}get classname(){return this.constructor.name}setDefaultConfig(t){d.defaultConfigByClassName[this.classname]=t}get fullInst(){const t=this.constructor.name;return d._firstFullInstMapByClassName[t]||(d._firstFullInstMapByClassName[t]=this),d._firstFullInstMapByClassName[t]}startLoading(){if(!this.isFull){this.loadingInst=this.buildLoading();return}this.fullStart()}endLoading(){if(!this.isFull){this.closeLoading(this.loadingInst);return}this.fullClose()}fullStart(){const t=this.fullInst;t.reqIngNum++,t.reqCount++,t.needWaitLoading&&(t.waitLoading(),t.needWaitLoading=!1),this.upText(this.getText()),t.waitClose.cancel()}get waitLoading(){const t=this.fullInst;return t._waitLoading||(t._waitLoading=r.debounce(()=>{t.fullLoadingSingleInst=this.buildLoading()},1e3)),t._waitLoading}get waitClose(){const t=this.fullInst;return t._waitClose||(t._waitClose=r.debounce(()=>{t.reqIngNum=0,t.reqCount=0,t.needWaitLoading=!0,this.closeLoading(t.fullLoadingSingleInst)},800)),t._waitClose}fullClose(){const t=this.fullInst;t.reqIngNum--,this.upText(this.getText()),t.reqIngNum<=0&&(t.waitLoading.cancel(),t.waitClose())}getText(t="\u52A0\u8F7D\u4E2D"){let{reqCount:e,reqIngNum:n}=this.fullInst;if(e>1){let a=1-n/e;a=(a*100).toFixed(0),t=`\u5DF2\u52A0\u8F7D ${a}%`}return t}};let g=d;o(g,"defaultConfigByClassName",{}),o(g,"_firstFullInstMapByClassName",{}),s.BaseLoading=g,s.LoadingRequest=T,s.RequestModel=_,s.setLoadingConfig=D,s.setLoadingMap=x,s.setRequestMap=N,Object.defineProperty(s,"__esModule",{value:!0}),s[Symbol.toStringTag]="Module"});
